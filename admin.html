<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Code For All</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="icon" type="image/png" href="favicon.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <!-- Navigation -->
    <header>
        <div class="container">
            <div class="logo">
                <img src="favicon.png" alt="Code For All Logo" class="logo-img">
                <h1>Code For All</h1>
            </div>
            <nav>
                <ul>
                    <li><a href="index.html">Home</a></li>
                    <li><a href="events.html">Events</a></li>
                    <li><a href="team.html">Our Team</a></li>
                    <li><a href="contact.html">Get Involved</a></li>
                    <li><a href="admin.html" class="admin-link active">Admin Panel</a></li>
                    <li><a href="login.html" class="login-btn">Login</a></li>
                </ul>
            </nav>
            <div class="menu-toggle">
                <i class="fas fa-bars"></i>
            </div>
        </div>
    </header>

    <!-- Admin Panel Section -->
    <section class="admin-section">
        <div class="container">
            <div class="admin-header">
                <h1><i class="fas fa-shield-alt"></i> Admin Panel</h1>
                <p>Manage users and system settings</p>
            </div>

            <!-- Admin Stats -->
            <div class="admin-stats">
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="total-users">0</h3>
                        <p>Total Users</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-user-shield"></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="admin-users">0</h3>
                        <p>Admin Users</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-user-check"></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="regular-users">0</h3>
                        <p>Regular Users</p>
                    </div>
                </div>
            </div>

            <!-- User Management -->
            <div class="admin-panel">
                <div class="panel-header">
                    <h2><i class="fas fa-users-cog"></i> User Management</h2>
                    <button class="btn btn-primary" onclick="showAddUserModal()">
                        <i class="fas fa-plus"></i> Add New User
                    </button>
                </div>

                <!-- Search and Filter -->
                <div class="admin-controls">
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" id="user-search" placeholder="Search users..." onkeyup="filterUsers()">
                    </div>
                    <div class="filter-box">
                        <select id="role-filter" onchange="filterUsers()">
                            <option value="all">All Roles</option>
                            <option value="admin">Admin</option>
                            <option value="user">User</option>
                        </select>
                    </div>
                </div>

                <!-- Users Table -->
                <div class="users-table-container">
                    <table class="users-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Username</th>
                                <th>Email</th>
                                <th>Role</th>
                                <th>Created</th>
                                <th>Last Login</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="users-table-body">
                            <!-- Users will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </section>

    <!-- Add User Modal -->
    <div id="add-user-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-user-plus"></i> Add New User</h3>
                <span class="close" onclick="closeAddUserModal()">&times;</span>
            </div>
            <form id="add-user-form">
                <div class="form-group">
                    <label for="new-name">Full Name</label>
                    <input type="text" id="new-name" name="name" required>
                </div>
                <div class="form-group">
                    <label for="new-username">Username</label>
                    <input type="text" id="new-username" name="username" required>
                </div>
                <div class="form-group">
                    <label for="new-email">Email</label>
                    <input type="email" id="new-email" name="email" required>
                </div>
                <div class="form-group">
                    <label for="new-password">Password</label>
                    <input type="password" id="new-password" name="password" required minlength="6">
                </div>
                <div class="form-group">
                    <label for="new-role">Role</label>
                    <select id="new-role" name="role" required>
                        <option value="user">User</option>
                        <option value="admin">Admin</option>
                    </select>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeAddUserModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add User</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit User Modal -->
    <div id="edit-user-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-user-edit"></i> Edit User</h3>
                <span class="close" onclick="closeEditUserModal()">&times;</span>
            </div>
            <form id="edit-user-form">
                <input type="hidden" id="edit-user-id">
                <div class="form-group">
                    <label for="edit-username">Username</label>
                    <input type="text" id="edit-username" name="username" required>
                </div>
                <div class="form-group">
                    <label for="edit-email">Email</label>
                    <input type="email" id="edit-email" name="email" required>
                </div>
                <div class="form-group">
                    <label for="edit-role">Role</label>
                    <select id="edit-role" name="role" required>
                        <option value="user">User</option>
                        <option value="admin">Admin</option>
                    </select>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeEditUserModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update User</button>
                </div>
            </form>
        </div>
    </div>

    <!-- User Details Modal -->
    <div id="user-details-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-user"></i> User Details</h3>
                <span class="close" onclick="closeUserDetailsModal()">&times;</span>
            </div>
            <div class="user-details-content">
                <div class="detail-row">
                    <label>ID:</label>
                    <span id="detail-user-id"></span>
                </div>
                <div class="detail-row">
                    <label>Username:</label>
                    <span id="detail-username"></span>
                </div>
                <div class="detail-row">
                    <label>Email:</label>
                    <span id="detail-email"></span>
                </div>
                <div class="detail-row">
                    <label>Password:</label>
                    <span id="detail-password" class="password-field"></span>
                    <button type="button" class="btn-icon" onclick="togglePasswordVisibility()" title="Toggle Password">
                        <i id="password-toggle-icon" class="fas fa-eye"></i>
                    </button>
                </div>
                <div class="detail-row">
                    <label>Role:</label>
                    <span id="detail-role" class="role-badge"></span>
                </div>
                <div class="detail-row">
                    <label>Created At:</label>
                    <span id="detail-created-at"></span>
                </div>
                <div class="detail-row">
                    <label>Last Login:</label>
                    <span id="detail-last-login"></span>
                </div>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="closeUserDetailsModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <div class="footer-logo">
                        <img src="logo_small_light.png" alt="Code For All Logo" class="logo">
                        <span>Code For All</span>
                    </div>
                    <p>Empowering students through coding education and community service.</p>
                </div>
                <div class="footer-section">
                    <h3>Quick Links</h3>
                    <ul>
                        <li><a href="index.html">Home</a></li>
                        <li><a href="events.html">Events</a></li>
                        <li><a href="team.html">Team</a></li>
                        <li><a href="contact.html">Get Involved</a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h3>Contact Info</h3>
                    <p>Email: zhu47578@sas.edu.sg</p>
                    <p>Phone: +65 8647 2776</p>
                    <p>Address: 40 Woodlands Street 41, Singapore 738547</p>
                </div>
                <div class="footer-contact">
                    <h3>Follow Us</h3>
                    <div class="social-icons">
                        <a href="https://www.instagram.com" target="_blank"><i class="fab fa-instagram"></i></a>
                        <a href="https://www.twitter.com" target="_blank"><i class="fab fa-twitter"></i></a>
                        <a href="https://www.facebook.com" target="_blank"><i class="fab fa-facebook"></i></a>
                    </div>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2025 Code For All. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <script src="script.js"></script>
    <script>
        // Admin Panel JavaScript
        let allUsers = [];
        let filteredUsers = [];

        // Load users when page loads
        document.addEventListener('DOMContentLoaded', async function() {
            await loadAdminData();
            displayUsers();
            updateStats();
        });

        async function loadAdminData() {
            try {
                const response = await fetch('users.json');
                const data = await response.json();
                allUsers = data.users || [];
                filteredUsers = [...allUsers];
            } catch (error) {
                console.error('Error loading user data:', error);
                authSystem.showMessage('Error loading user data', 'error');
            }
        }

        function updateStats() {
            const totalUsers = allUsers.length;
            const adminUsers = allUsers.filter(user => user.role === 'admin').length;
            const regularUsers = allUsers.filter(user => user.role === 'user').length;

            document.getElementById('total-users').textContent = totalUsers;
            document.getElementById('admin-users').textContent = adminUsers;
            document.getElementById('regular-users').textContent = regularUsers;
        }

        function displayUsers() {
            const tbody = document.getElementById('users-table-body');
            tbody.innerHTML = '';

            filteredUsers.forEach(user => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${user.id}</td>
                    <td><a href="#" onclick="viewUserDetails(${user.id})" class="user-link">${user.username}</a></td>
                    <td>${user.email}</td>
                    <td><span class="role-badge ${user.role}">${user.role}</span></td>
                    <td>${formatDate(user.created_at)}</td>
                    <td>${user.last_login ? formatDate(user.last_login) : 'Never'}</td>
                    <td class="actions">
                        <button class="btn-icon view" onclick="viewUserDetails(${user.id})" title="View Details">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn-icon edit" onclick="editUser(${user.id})" title="Edit User">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn-icon delete" onclick="deleteUser(${user.id})" title="Delete User">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function filterUsers() {
            const searchTerm = document.getElementById('user-search').value.toLowerCase();
            const roleFilter = document.getElementById('role-filter').value;

            filteredUsers = allUsers.filter(user => {
                const matchesSearch = user.username.toLowerCase().includes(searchTerm) ||
                                    user.email.toLowerCase().includes(searchTerm);
                const matchesRole = roleFilter === 'all' || user.role === roleFilter;
                return matchesSearch && matchesRole;
            });

            displayUsers();
        }

        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            return new Date(dateString).toLocaleDateString();
        }

        function showAddUserModal() {
            document.getElementById('add-user-modal').style.display = 'block';
        }

        function closeAddUserModal() {
            document.getElementById('add-user-modal').style.display = 'none';
            document.getElementById('add-user-form').reset();
        }

        function editUser(userId) {
            const user = allUsers.find(u => u.id === userId);
            if (user) {
                document.getElementById('edit-user-id').value = user.id;
                document.getElementById('edit-username').value = user.username;
                document.getElementById('edit-email').value = user.email;
                document.getElementById('edit-role').value = user.role;
                document.getElementById('edit-user-modal').style.display = 'block';
            }
        }

        function closeEditUserModal() {
            document.getElementById('edit-user-modal').style.display = 'none';
            document.getElementById('edit-user-form').reset();
        }

        function deleteUser(userId) {
            if (confirm('Are you sure you want to delete this user?')) {
                authSystem.showMessage('User deletion functionality would be implemented with backend integration', 'info');
            }
        }

        function viewUserDetails(userId) {
            const user = allUsers.find(u => u.id === userId);
            if (user) {
                document.getElementById('detail-user-id').textContent = user.id;
                document.getElementById('detail-username').textContent = user.username;
                document.getElementById('detail-email').textContent = user.email;
                document.getElementById('detail-password').textContent = '••••••••';
                document.getElementById('detail-password').setAttribute('data-password', user.password);
                document.getElementById('detail-role').textContent = user.role;
                document.getElementById('detail-role').className = `role-badge ${user.role}`;
                document.getElementById('detail-created-at').textContent = formatDate(user.created_at);
                document.getElementById('detail-last-login').textContent = user.last_login ? formatDate(user.last_login) : 'Never';
                
                // Reset password visibility
                document.getElementById('detail-password').textContent = '••••••••';
                document.getElementById('password-toggle-icon').className = 'fas fa-eye';
                
                document.getElementById('user-details-modal').style.display = 'block';
            }
        }

        function closeUserDetailsModal() {
            document.getElementById('user-details-modal').style.display = 'none';
        }

        function togglePasswordVisibility() {
            const passwordField = document.getElementById('detail-password');
            const toggleIcon = document.getElementById('password-toggle-icon');
            const actualPassword = passwordField.getAttribute('data-password');
            
            if (passwordField.textContent === '••••••••') {
                passwordField.textContent = actualPassword;
                toggleIcon.className = 'fas fa-eye-slash';
            } else {
                passwordField.textContent = '••••••••';
                toggleIcon.className = 'fas fa-eye';
            }
        }

        // Form submissions
        document.getElementById('add-user-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Get form data
            const formData = new FormData(e.target);
            const userData = {
                username: formData.get('username'),
                name: formData.get('name'),
                email: formData.get('email'),
                password: formData.get('password'),
                role: formData.get('role')
            };
            
            // Validate form data
            if (!userData.name || !userData.username || !userData.email || !userData.password) {
                authSystem.showMessage('Please fill in all required fields', 'error');
                return;
            }
            
            if (userData.password.length < 6) {
                authSystem.showMessage('Password must be at least 6 characters long', 'error');
                return;
            }
            
            // Check if user already exists
            const existingUser = allUsers.find(user => 
                user.email.toLowerCase() === userData.email.toLowerCase() || 
                user.username.toLowerCase() === userData.username.toLowerCase()
            );
            
            if (existingUser) {
                authSystem.showMessage('User with this email or username already exists', 'error');
                return;
            }
            
            try {
                // Send to backend
                const response = await fetch('/save-user', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(userData)
                });
                
                if (response.ok) {
                    authSystem.showMessage('User created successfully!', 'success');
                    closeAddUserModal();
                    // Reload users to show the new user
                    await loadAdminData();
                    displayUsers();
                    updateStats();
                } else {
                    const errorData = await response.text();
                    authSystem.showMessage('Failed to create user: ' + errorData, 'error');
                }
            } catch (error) {
                console.error('Error creating user:', error);
                authSystem.showMessage('Error creating user. Please try again.', 'error');
            }
        });

        document.getElementById('edit-user-form').addEventListener('submit', function(e) {
            e.preventDefault();
            authSystem.showMessage('User update functionality would be implemented with backend integration', 'info');
            closeEditUserModal();
        });

        // Close modals when clicking outside
        window.onclick = function(event) {
            const addModal = document.getElementById('add-user-modal');
            const editModal = document.getElementById('edit-user-modal');
            const detailsModal = document.getElementById('user-details-modal');
            if (event.target === addModal) {
                closeAddUserModal();
            }
            if (event.target === editModal) {
                closeEditUserModal();
            }
            if (event.target === detailsModal) {
                closeUserDetailsModal();
            }
        }
    </script>
</body>
</html>